@page "/"
@using EksploracjaDanych.Models
<PageTitle>Eksploracja danych</PageTitle>
<div class="form-group">
    <h1 class="text-lg-center">Wyznaczanie modelu</h1>

    <select class="form-select mt-2" id="dataType" @bind="_modelType">
        <option selected value="-1">Wybierz model</option>
        <option value="0">MODEL KLASYFIKACYJNY</option>
        <option value="1">MODEL REGRESYJNY</option>
    </select>

    @if (_isBadModel)
    {
        <p class="text-danger">Proszę wybrać poprawny model.</p>
    }

    <InputFile class="form-control mt-2" OnChange="@OnInputFileChange"/>
    @if (_wrongFileType)
    {
        <p class="text-danger">Zły format pliku\Brak pliku.</p>
    }
    <button type="button" class="btn btn-outline-dark mt-2 float-end" @onclick="Generate">
        @if (_loading)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span>Generuję...</span>
        }
        else
        {
            <span>Oblicz dane</span>
        }
    </button>
</div>

@if (_calculated)
{
    if ((ModelType)_modelType == ModelType.Classification)
    {
        <div class="mt-3 d-inline-flex w-100">
            <ConfusionTable ConfusionMatrix="@_classificationMatrix1" Title="Model pierwszy"/>
            <ConfusionTable ConfusionMatrix="@_classificationMatrix2" Title="Model drugi"/>
            <LineChart Values="@_values.ToList()" Min="-1" Max="100"></LineChart>
        </div>
    }
}

@code
{
    private readonly int _maxAllowedFileSize = 1024 * 1024 * 1024 * 1;

    // sample double array
    private double[] _values = new double[] { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 };
    private bool _isBadModel;
    private bool _wrongFileType;
    private bool _loading;
    private bool _calculated;
    private int _modelType = -1;

    private IBrowserFile? _file;

    private ConfusionMatrix _classificationMatrix1 = null!;
    private ConfusionMatrix _classificationMatrix2 = null!;

    private Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        var file = e.File;
        try
        {
            if (file.ContentType != "text/csv")
            {
                _wrongFileType = true;
                return Task.CompletedTask;
            }

            _file = file;
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }
        return Task.CompletedTask;
    }

    private async Task Generate()
    {
        if (_modelType is (int)ModelType.Default)
        {
            _isBadModel = true;
            return;
        }
        _isBadModel = false;

        if (_file is null)
        {
            _wrongFileType = true;
            return;
        }
        _wrongFileType = false;
        _loading = true;

        var reader =
            await new StreamReader(_file.OpenReadStream(_maxAllowedFileSize)).ReadToEndAsync();
        var data = reader.Split("\r\n").Select(x => x.Split(",")).ToList();
        switch ((ModelType)_modelType)
        {
            case ModelType.Classification:
                Classification(data);
                _loading = false;
                _calculated = true;
                break;

            case ModelType.Regression:
                Regression(data);
                _loading = false;
                _calculated = true;
                break;

            default:
                throw new ArgumentOutOfRangeException();
        }
    }

    private void Classification(List<string[]> data)
    {
        var confusionMatrixModel1 = new ConfusionMatrix();
        var confusionMatrixModel2 = new ConfusionMatrix();

        foreach (var row in data.Skip(1).SkipLast(1).ToList())
        {
            var realValue = row[0];
            var model1Value = row[1];
            var model2Value = row[3];

    // True value == <=50k
            if (realValue.Equals(">50K"))
            {
                if (model1Value == realValue)
                    confusionMatrixModel1.AddTruePositive();
                else
                    confusionMatrixModel1.AddFalseNegative();

                if (model2Value == realValue)
                    confusionMatrixModel2.AddTruePositive();
                else
                    confusionMatrixModel2.AddFalseNegative();
            }

    // False value == >50k
            else if (row[0].Equals("<=50K"))
            {
                if (model1Value == realValue)
                    confusionMatrixModel1.AddTrueNegative();
                else
                    confusionMatrixModel1.AddFalsePositive();

                if (model2Value == realValue)
                    confusionMatrixModel2.AddTrueNegative();
                else
                    confusionMatrixModel2.AddFalsePositive();
            }
        }
        _classificationMatrix1 = confusionMatrixModel1;
        _classificationMatrix2 = confusionMatrixModel2;
    }

    private void Regression(List<string[]> data)
    {
        var fixedData = data.Skip(1).SkipLast(1).Select(x => x.Select(y => double.Parse(y)).ToArray()).ToList();
        
    }

    private enum ModelType
    {
        Default = -1,
        Classification = 0,
        Regression = 1
    }
}